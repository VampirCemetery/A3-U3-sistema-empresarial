<!doctype html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Usuarios</title>
</head>

<body>
  <div th:replace="layout :: *">
    <div th:fragment="content">
      <div class="d-flex align-items-center mb-3">
        <h3 class="mb-0">Usuarios</h3>
        <button type="button" class="btn btn-sm btn-outline-info ms-3" data-bs-toggle="modal"
          data-bs-target="#rolesModal">
          <i class="fa-solid fa-circle-info"></i> Ver Roles del Sistema
        </button>
      </div>

      <div class="row">
        <div class="col-lg-8">
          <div class="table-responsive">
            <table class="table table-bordered table-hover align-middle">
              <thead class="table-light">
                <tr>
                  <th>ID</th>
                  <th>Usuario</th>
                  <th>Nombre</th>
                  <th>Email</th>
                  <th>Roles</th>
                  <th>Activo</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr th:each="u : ${usuarios}">
                  <td th:text="${u.id}">1</td>
                  <td th:text="${u.username}">user</td>
                  <td th:text="${u.nombreCompleto}">Nombre</td>
                  <td th:text="${u.email}">email</td>
                  <td>
                    <span th:each="rol, iterStat : ${u.roles}" class="badge bg-primary me-1">
                      <span th:text="${rol.nombre}">ROLE</span><span th:if="!${iterStat.last}">,</span>
                    </span>
                    <span th:if="${#lists.isEmpty(u.roles)}" class="text-muted small">Sin rol</span>
                  </td>
                  <td th:text="${u.activo ? 'Sí' : 'No'}">Sí</td>
                  <td>
                    <form th:id="'deleteForm' + ${u.id}" th:action="@{'/usuarios/' + ${u.id} + '/delete'}"
                      method="post">
                      <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                      <button type="button" class="btn btn-sm btn-danger py-0 px-2" style="font-size: 0.8rem;"
                        data-bs-toggle="modal" data-bs-target="#deleteModal"
                        th:attr="data-usuario-id=${u.id}, data-usuario-nombre=${u.nombreCompleto}">
                        <i class="fa-solid fa-trash"></i>
                      </button>
                    </form>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="col-lg-4">
          <div class="card">
            <div class="card-body p-3">
              <h6 class="mb-3">Crear Usuario Rápido</h6>
              <form method="post" th:object="${usuario}">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <div class="row g-2">
                  <div class="col-12">
                    <label class="form-label small mb-1">Usuario</label>
                    <input class="form-control form-control-sm" th:field="*{username}" required>
                  </div>
                  <div class="col-12">
                    <label class="form-label small mb-1">Nombre completo</label>
                    <input class="form-control form-control-sm" th:field="*{nombreCompleto}" required>
                  </div>
                  <div class="col-12">
                    <label class="form-label small mb-1">Email</label>
                    <input type="email" class="form-control form-control-sm" th:field="*{email}" required>
                  </div>
                  <div class="col-12">
                    <label class="form-label small mb-1">Contraseña</label>
                    <input type="password" class="form-control form-control-sm" th:field="*{password}" required>
                    <small class="text-muted d-block mt-1" style="font-size: 0.7rem;">(Se encriptará con BCrypt)</small>
                  </div>
                  <div class="col-12">
                    <label class="form-label small mb-1">Rol <span class="text-muted">(opcional)</span></label>
                    <select class="form-select form-select-sm" name="rolId">
                      <option value="">Sin rol específico (se asignará USER)</option>
                      <option th:each="rol : ${roles}" th:value="${rol.id}" th:text="${rol.nombre}">ROL</option>
                    </select>
                    <small class="text-muted d-block mt-1" style="font-size: 0.7rem;">Si no seleccionas ninguno, se
                      asignará el rol USER automáticamente</small>
                  </div>
                </div>
                <button class="btn btn-primary w-100 btn-sm mt-3">Guardar</button>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal de información de roles -->
      <div class="modal fade" id="rolesModal" tabindex="-1" aria-labelledby="rolesModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="rolesModalLabel">
                <i class="fa-solid fa-users-gear"></i> Roles Disponibles en el Sistema
              </h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <h6><span class="badge bg-danger"><i class="fa-solid fa-shield-halved"></i> ADMIN</span></h6>
                <p class="text-muted small mb-0">Acceso total al sistema. Puede gestionar usuarios, ver todos los
                  dashboards y realizar cualquier operación.</p>
              </div>
              <div class="mb-3">
                <h6><span class="badge bg-success"><i class="fa-solid fa-boxes-stacked"></i> INVENTARIO</span></h6>
                <p class="text-muted small mb-0">Gestión de productos e inventario. Puede agregar, editar y eliminar
                  productos, así como ajustar el stock.</p>
              </div>
              <div class="mb-3">
                <h6><span class="badge bg-primary"><i class="fa-solid fa-dollar-sign"></i> VENTAS</span></h6>
                <p class="text-muted small mb-0">Registro y gestión de ventas. Puede crear ventas, ver el historial y
                  acceder al dashboard de ventas.</p>
              </div>
              <div class="mb-3">
                <h6><span class="badge bg-warning text-dark"><i class="fa-solid fa-cart-shopping"></i> COMPRAS</span>
                </h6>
                <p class="text-muted small mb-0">Registro y gestión de compras. Puede crear órdenes de compra, ver el
                  historial y acceder al dashboard de compras.</p>
              </div>
              <div class="mb-0">
                <h6><span class="badge bg-secondary"><i class="fa-solid fa-user"></i> USER</span></h6>
                <p class="text-muted small mb-0">Usuario normal con acceso de solo lectura al catálogo de productos. No
                  puede realizar operaciones administrativas.</p>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cerrar</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal de confirmación de eliminación -->
      <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="deleteModalLabel">Confirmar Eliminación</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              ¿Está seguro que desea eliminar al usuario <strong id="usuarioNombre"></strong>?
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Eliminar</button>
            </div>
          </div>
        </div>
      </div>

      <script>
        document.addEventListener('DOMContentLoaded', function () {
          // Inicializar DataTable solo si está disponible
          if (typeof DataTable !== 'undefined') {
            try {
              new DataTable('#tbl');
            } catch (e) {
              console.warn('DataTable initialization failed:', e);
            }
          }

          // Manejar la confirmación de eliminación
          const deleteModal = document.getElementById('deleteModal');
          const confirmBtn = document.getElementById('confirmDeleteBtn');
          let formToSubmit = null;

          if (!deleteModal || !confirmBtn) {
            console.error('Modal elements not found');
            return;
          }

          deleteModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const usuarioId = button.getAttribute('data-usuario-id');
            const usuarioNombre = button.getAttribute('data-usuario-nombre');

            document.getElementById('usuarioNombre').textContent = usuarioNombre;
            formToSubmit = document.getElementById('deleteForm' + usuarioId);

            console.log('Modal opened for user:', usuarioId, usuarioNombre);
            console.log('Form found:', formToSubmit);
          });

          confirmBtn.addEventListener('click', function () {
            console.log('Delete button clicked');
            if (formToSubmit) {
              console.log('Submitting form:', formToSubmit.id);
              // Cerrar el modal primero
              const modalInstance = bootstrap.Modal.getInstance(deleteModal);
              if (modalInstance) {
                modalInstance.hide();
              }
              // Enviar el formulario
              formToSubmit.submit();
            } else {
              console.error('Form not found!');
            }
          });
        });
      </script>
    </div>
  </div>
</body>

</html>