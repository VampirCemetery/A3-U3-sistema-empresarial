<!doctype html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Nueva Venta</title>
</head>

<body>
    <div th:fragment="content">
        <h3 class="mb-3">Nueva Venta</h3>

        <div class="card mb-3">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Cliente</label>
                        <select id="clienteSelect" class="form-select">
                            <option value="">Seleccione un cliente...</option>
                            <option th:each="c : ${clientes}" th:value="${c.id}" th:text="${c.nombre}"></option>
                        </select>
                    </div>
                    <div class="col-md-6 d-flex align-items-end">
                        <div class="text-end w-100">
                            <h5>Total: <span id="totalDisplay">$0.00</span></h5>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-3">
            <div class="card-header bg-light">
                <div class="row g-2 align-items-end">
                    <div class="col-md-4">
                        <label class="small mb-1">Producto</label>
                        <select id="productoSelect" class="form-select form-select-sm">
                            <option value="">Seleccione un producto...</option>
                            <option th:each="p : ${productos}" th:value="${p.id}" th:data-precio="${p.precioVenta}"
                                th:data-stock="${p.stockActual}"
                                th:text="${p.codigo + ' - ' + p.nombre + ' (Stock: ' + p.stockActual + ')'}">
                            </option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="small mb-1">Precio Unit.</label>
                        <input type="number" id="precioInput" class="form-control form-control-sm" readonly>
                    </div>
                    <div class="col-md-2">
                        <label class="small mb-1">Cantidad</label>
                        <input type="number" id="cantidadInput" class="form-control form-control-sm" value="1" min="1">
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-sm btn-success w-100" onclick="agregarProducto()">
                            <i class="fa-solid fa-plus me-1"></i>Agregar
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-bordered mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Producto</th>
                                <th class="text-end" width="120">Precio</th>
                                <th class="text-center" width="100">Cant.</th>
                                <th class="text-end" width="120">Subtotal</th>
                                <th class="text-center" width="80"></th>
                            </tr>
                        </thead>
                        <tbody id="detallesBody">
                            <!-- Rows added by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="text-end">
            <a href="/dashboard/ventas" class="btn btn-secondary me-2">Cancelar</a>
            <button class="btn btn-primary" onclick="guardarVenta()">
                <i class="fa-solid fa-save me-2"></i>Registrar Venta
            </button>
        </div>

        <script th:inline="javascript">
            /*<![CDATA[*/
            const csrfToken = /*[[${_csrf.token}]]*/ '';
            const csrfHeader = /*[[${_csrf.headerName}]]*/ 'X-CSRF-TOKEN';
            /*]]>*/

            let items = [];

            // Update price input when product selected
            document.getElementById('productoSelect').addEventListener('change', function () {
                const option = this.options[this.selectedIndex];
                if (option.value) {
                    const precio = option.getAttribute('data-precio');
                    document.getElementById('precioInput').value = precio ? precio : 0;
                }
            });

            function agregarProducto() {
                const select = document.getElementById('productoSelect');
                const cantidadInput = document.getElementById('cantidadInput');
                const precioInput = document.getElementById('precioInput');

                const productoId = select.value;
                if (!productoId) return alert('Seleccione un producto');

                const option = select.options[select.selectedIndex];
                const nombre = option.text;
                const precio = parseFloat(precioInput.value);
                const cantidad = parseInt(cantidadInput.value);
                const stock = parseInt(option.getAttribute('data-stock'));

                if (cantidad <= 0) return alert('Cantidad inválida');
                if (cantidad > stock) return alert('Stock insuficiente (Máx: ' + stock + ')');

                // Check if already added
                const existing = items.find(i => i.productoId === productoId);
                if (existing) {
                    if (existing.cantidad + cantidad > stock) return alert('Stock insuficiente para la cantidad total');
                    existing.cantidad += cantidad;
                    existing.subtotal = existing.cantidad * existing.precioUnitario;
                } else {
                    items.push({
                        productoId: productoId,
                        nombre: nombre,
                        precioUnitario: precio,
                        cantidad: cantidad,
                        subtotal: cantidad * precio
                    });
                }

                renderTabla();
                select.value = '';
                cantidadInput.value = 1;
                precioInput.value = '';
            }

            function eliminarItem(index) {
                items.splice(index, 1);
                renderTabla();
            }

            function renderTabla() {
                const tbody = document.getElementById('detallesBody');
                tbody.innerHTML = '';
                let total = 0;

                items.forEach((item, index) => {
                    total += item.subtotal;
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
              <td>${item.nombre}</td>
              <td class="text-end">$${item.precioUnitario.toFixed(2)}</td>
              <td class="text-center">${item.cantidad}</td>
              <td class="text-end">$${item.subtotal.toFixed(2)}</td>
              <td class="text-center">
                <button class="btn btn-sm btn-danger py-0 px-2" onclick="eliminarItem(${index})">&times;</button>
              </td>
            `;
                    tbody.appendChild(tr);
                });

                document.getElementById('totalDisplay').textContent = '$' + total.toFixed(2);
            }

            function guardarVenta() {
                const clienteId = document.getElementById('clienteSelect').value;
                if (!clienteId) return alert('Seleccione un cliente');
                if (items.length === 0) return alert('Agregue al menos un producto');

                const data = {
                    clienteId: parseInt(clienteId),
                    items: items.map(i => ({
                        productoId: parseInt(i.productoId),
                        cantidad: i.cantidad,
                        precioUnitario: i.precioUnitario
                    }))
                };

                fetch('/ventas/guardar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        [csrfHeader]: csrfToken
                    },
                    body: JSON.stringify(data)
                })
                    .then(response => response.json())
                    .then(res => {
                        if (res.error) {
                            alert('Error: ' + res.error);
                        } else {
                            alert(res.message);
                            window.location.href = '/dashboard/ventas';
                        }
                    })
                    .catch(err => alert('Error de conexión'));
            }
        </script>
    </div>
</body>

</html>